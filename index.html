<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL VOID | Dopamine Defense</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;400;500;600;700&family=Inter:wght@300;400;600&display=swap');

        :root {
            --void-black: #030712;
            --nebula-indigo: #6366f1;
            --hologram-cyan: #06b6d4;
            --alert-red: #f43f5e;
            --star-white: #f8fafc;
            --hud-bg: rgba(6, 182, 212, 0.03);
            --hud-border: rgba(6, 182, 212, 0.3);
            --glass-panel: rgba(3, 7, 18, 0.75);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            cursor: crosshair;
        }

        body {
            background-color: var(--void-black);
            color: var(--star-white);
            font-family: 'Rajdhani', sans-serif;
            min-height: 100vh;
            overflow: hidden;
            /* Prevent body scroll, handle in slides */
        }

        /* --- BACKGROUND --- */
        #three-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* --- HUD PANELS (FIXED) --- */
        .holo-panel {
            background: var(--glass-panel);
            border: 1px solid var(--hud-border);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.1), inset 0 0 20px rgba(6, 182, 212, 0.05);
            backdrop-filter: blur(12px);
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-radius: 12px;
        }

        .holo-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, var(--hologram-cyan), transparent);
            opacity: 0.5;
            z-index: 10;
        }

        .holo-panel:hover {
            box-shadow: 0 0 25px rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.6);
        }

        /* --- CHART CONTAINERS (CRITICAL FIX) --- */
        /* This forces the chart container to actually fill the flex parent */
        .chart-wrapper {
            position: relative;
            flex-grow: 1;
            width: 100%;
            min-height: 0;
            /* Important for Flexbox scrolling */
            overflow: hidden;
        }

        .chart-fill {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* --- TYPOGRAPHY --- */
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .gradient-text {
            background: linear-gradient(135deg, var(--hologram-cyan) 0%, var(--nebula-indigo) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* --- BUTTONS --- */
        .btn-intergalactic {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid var(--hologram-cyan);
            color: var(--hologram-cyan);
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            z-index: 50;
        }

        .btn-intergalactic:hover {
            background: var(--hologram-cyan);
            color: var(--void-black);
            box-shadow: 0 0 30px var(--hologram-cyan);
        }

        /* --- LOADER --- */
        .warp-loader {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 3px solid transparent;
            border-top-color: var(--hologram-cyan);
            border-bottom-color: var(--nebula-indigo);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* --- SLIDE SYSTEM --- */
        .viewport {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding-top: 80px;
            /* Header space */
            padding-bottom: 20px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
            opacity: 1;
            /* Fix visibility issues */
        }

        #welcomeState {
            transform: translateX(0);
            z-index: 20;
        }

        #dashboard {
            transform: translateX(100%);
            z-index: 20;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: var(--void-black);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--hologram-cyan);
            border-radius: 3px;
        }

        .step-item {
            color: #334155;
            transition: all 0.3s;
        }

        .step-item.active {
            color: #06b6d4;
            transform: scale(1.2);
        }

        .step-item.done {
            color: #10b981;
        }
    </style>
</head>

<body>
    <canvas id="three-canvas"></canvas>

    <header
        class="fixed top-0 left-0 w-full z-40 px-6 py-4 flex justify-between items-center border-b border-white/10 bg-black/80 backdrop-blur-md">
        <div class="flex items-center gap-4">
            <div class="w-8 h-8 border border-cyan-500 rounded-full flex items-center justify-center animate-pulse">
                <i class="fa-solid fa-atom text-cyan-400"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold gradient-text tracking-widest uppercase">NeuraLink <span
                        class="text-xs opacity-70">v.9.0</span></h1>
            </div>
        </div>
        <div class="flex gap-4 font-orbitron text-[10px] tracking-widest">
            <div id="ind-airlock" class="text-cyan-400 cursor-pointer" onclick="navigateSlide(0)">AIRLOCK</div>
            <div class="text-slate-600">>>></div>
            <div id="ind-deck" class="text-slate-600 cursor-pointer hover:text-cyan-400 transition"
                onclick="navigateSlide(1)">COMMAND_DECK</div>
        </div>
        <div class="flex items-center gap-4 text-[10px] font-mono text-cyan-500/70">
            <span class="hidden md:inline">SYS.STATUS: <span class="text-green-400">ONLINE</span></span>
            <button onclick="resetSystem()" class="hover:text-cyan-400"><i class="fa-solid fa-rotate-right"></i>
                RESET</button>
        </div>
    </header>

    <main class="viewport">

        <div id="welcomeState" class="slide flex items-center justify-center">
            <div class="holo-panel p-1 max-w-xl w-full mx-4">
                <div class="bg-black/80 p-10 rounded-lg flex flex-col items-center text-center">
                    <div id="neural-core-container" class="w-40 h-40 mb-6"></div>
                    <h2 class="text-4xl font-bold text-white mb-2"><span class="text-cyan-400">INITIALIZE</span> UPLINK
                    </h2>
                    <p class="text-slate-400 mb-8 text-sm">Transmit TikTok behavioral logs for analysis.</p>

                    <div id="dropZone"
                        class="w-full border-2 border-dashed border-cyan-500/30 rounded-lg p-8 mb-6 hover:bg-cyan-500/5 cursor-pointer transition-all"
                        onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" class="hidden" accept=".txt" onchange="handleFile()">
                        <i class="fa-solid fa-cloud-arrow-up text-3xl text-cyan-500 mb-3"></i>
                        <div class="text-xs font-orbitron text-cyan-300 tracking-widest">UPLOAD DATA PACKET</div>
                    </div>

                    <div class="flex gap-3 w-full">
                        <button onclick="document.getElementById('fileInput').click()"
                            class="btn-intergalactic flex-1 py-3 text-xs font-bold rounded">Select File</button>
                        <button onclick="loadSampleData()"
                            class="flex-1 py-3 text-xs font-bold text-slate-400 hover:text-white border border-slate-700 hover:border-slate-500 rounded transition">Simulation</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="dashboard" class="slide px-4 md:px-8">
            <div class="max-w-[1600px] mx-auto h-full flex flex-col">

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6" style="min-height: 280px;">

                    <div class="holo-panel p-5">
                        <h3 class="text-xs font-orbitron text-cyan-500 mb-2 tracking-widest">NEURAL_REACTIVITY</h3>
                        <div class="flex-grow flex items-center justify-center relative">
                            <div class="relative w-36 h-36">
                                <div
                                    class="absolute inset-0 rounded-full border-2 border-dashed border-cyan-900 animate-[spin_10s_linear_infinite]">
                                </div>
                                <div id="reactorFill" class="absolute inset-2 rounded-full transition-all duration-1000"
                                    style="background: conic-gradient(var(--hologram-cyan) 0deg, transparent 0deg); mask: radial-gradient(transparent 60%, black 61%); -webkit-mask: radial-gradient(transparent 60%, black 61%);">
                                </div>
                                <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                                    <div class="text-3xl font-black font-orbitron text-white" id="reactorValue">--%
                                    </div>
                                    <div class="text-[9px] text-cyan-400 tracking-widest">RISK LEVEL</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="holo-panel p-5">
                        <h3 class="text-xs font-orbitron text-cyan-500 mb-4 tracking-widest">WEEKLY_SIGNATURE</h3>
                        <div id="equalizerChart" class="flex items-end justify-between h-full w-full gap-2 pb-2"></div>
                    </div>

                    <div class="holo-panel p-0 border-cyan-500/50">
                        <div class="bg-cyan-900/20 p-3 border-b border-cyan-500/30 flex justify-between items-center">
                            <h3 class="text-xs font-orbitron text-white tracking-widest"><i
                                    class="fa-solid fa-brain mr-2"></i>AI_STRATEGIST</h3>
                            <div class="text-[9px] bg-cyan-500/20 px-2 py-0.5 rounded text-cyan-300">GEMINI-2.5</div>
                        </div>
                        <div id="geminiContent"
                            class="p-4 text-xs text-cyan-100/80 font-mono leading-relaxed overflow-y-auto h-full max-h-[220px]">
                            Awaiting data input...
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-grow mb-8" style="min-height: 400px;">

                    <div class="holo-panel p-5">
                        <div class="flex justify-between items-end mb-2">
                            <h3 class="text-xs font-orbitron text-cyan-500 tracking-widest">TEMPORAL_HEATMAP</h3>
                        </div>
                        <div class="chart-wrapper">
                            <div id="heatmapChart" class="chart-fill"></div>
                        </div>
                    </div>

                    <div class="holo-panel p-5">
                        <h3 class="text-xs font-orbitron text-cyan-500 mb-2 tracking-widest">ADDICTION_VELOCITY</h3>
                        <div class="chart-wrapper">
                            <div id="trendChart" class="chart-fill"></div>
                        </div>
                    </div>
                </div>

                <div id="statsFooter"
                    class="grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-white/5 rounded-lg border border-white/10 mb-8">
                </div>

            </div>
        </div>
    </main>

    <div id="loading"
        class="fixed inset-0 bg-black/95 z-50 hidden flex flex-col items-center justify-center backdrop-blur-md">
        <div class="warp-loader mb-8"></div>
        <div id="loadingText" class="text-xl font-bold text-white mb-4 font-orbitron tracking-widest animate-pulse">
            INITIALIZING...</div>
        <div class="flex gap-3 justify-center text-2xl">
            <div id="step-1" class="step-item"><i class="fa-solid fa-circle"></i></div>
            <div id="step-2" class="step-item"><i class="fa-solid fa-circle"></i></div>
            <div id="step-3" class="step-item"><i class="fa-solid fa-circle"></i></div>
            <div id="step-4" class="step-item"><i class="fa-solid fa-circle"></i></div>
        </div>
    </div>

    <script>

        // --- 1. NEURAL SYNAPSE NETWORK (Thematic Upgrade) ---
        const initSpace = () => {
            const canvas = document.getElementById('three-canvas');
            const scene = new THREE.Scene();

            // Deep fog for that "Void" depth
            scene.fog = new THREE.FogExp2(0x030712, 0.002);

            const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 1000);
            camera.position.z = 100;

            const renderer = new THREE.WebGLRenderer({
                canvas,
                alpha: false,
                antialias: true // Enabled for sharper lines
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

            // --- CONFIGURATION ---
            const particleCount = 130; // Keep < 200 for CPU performance
            const connectionDistance = 100;
            const particles = [];

            // Geometry for the nodes (Neurons)
            const particleGeo = new THREE.BufferGeometry();
            const particlePos = new Float32Array(particleCount * 3);

            // Geometry for the connections (Synapses)
            // Max connections = count * count (theoretical max, we use drawRange to limit)
            const lineGeo = new THREE.BufferGeometry();
            const linePos = new Float32Array(particleCount * particleCount * 3);
            lineGeo.setAttribute('position', new THREE.BufferAttribute(linePos, 3));

            // Material for Neurons (Cyan Dots)
            const particleMat = new THREE.PointsMaterial({
                color: 0x06b6d4, // --hologram-cyan
                size: 2,
                transparent: true,
                opacity: 0.8,
                blending: THREE.AdditiveBlending
            });

            // Material for Synapses (Indigo Lines)
            const lineMat = new THREE.LineBasicMaterial({
                color: 0x6366f1, // --nebula-indigo
                transparent: true,
                opacity: 0.35,
                blending: THREE.AdditiveBlending
            });

            // Initialize Particles
            for (let i = 0; i < particleCount; i++) {
                const x = (Math.random() - 0.5) * 800; // Spread width
                const y = (Math.random() - 0.5) * 600; // Spread height
                const z = (Math.random() - 0.5) * 600; // Spread depth

                particles.push({
                    x: x, y: y, z: z,
                    vx: (Math.random() - 0.5) * 0.4, // Velocity X
                    vy: (Math.random() - 0.5) * 0.4, // Velocity Y
                    vz: (Math.random() - 0.5) * 0.4  // Velocity Z
                });

                particlePos[i * 3] = x;
                particlePos[i * 3 + 1] = y;
                particlePos[i * 3 + 2] = z;
            }

            particleGeo.setAttribute('position', new THREE.BufferAttribute(particlePos, 3));

            const pointSystem = new THREE.Points(particleGeo, particleMat);
            const lineSystem = new THREE.LineSegments(lineGeo, lineMat);

            scene.add(pointSystem);
            scene.add(lineSystem);

            // --- ANIMATION LOOP ---
            const animate = () => {
                // 1. Update Particles
                let lineVertexIndex = 0;
                const positions = pointSystem.geometry.attributes.position.array;

                for (let i = 0; i < particleCount; i++) {
                    const p = particles[i];

                    // Move
                    p.x += p.vx;
                    p.y += p.vy;
                    p.z += p.vz;

                    // Bounce off "walls" (keep them in the void container)
                    if (p.x < -400 || p.x > 400) p.vx = -p.vx;
                    if (p.y < -300 || p.y > 300) p.vy = -p.vy;
                    if (p.z < -300 || p.z > 300) p.vz = -p.vz;

                    // Update Buffer
                    positions[i * 3] = p.x;
                    positions[i * 3 + 1] = p.y;
                    positions[i * 3 + 2] = p.z;

                    // 2. Check Connections (The heavy part)
                    // We only check particles ahead in the array to avoid duplicates
                    for (let j = i + 1; j < particleCount; j++) {
                        const p2 = particles[j];
                        const dx = p.x - p2.x;
                        const dy = p.y - p2.y;
                        const dz = p.z - p2.z;
                        const distSq = dx * dx + dy * dy + dz * dz;

                        if (distSq < connectionDistance * connectionDistance) {
                            // Create a line between p and p2
                            // Opacity based on distance (closer = brighter)
                            // Note: LineBasicMaterial opacity is global, so we just draw the line here.
                            // For per-line opacity, we'd need a ShaderMaterial, but that's complex.

                            const lPos = lineSystem.geometry.attributes.position.array;

                            lPos[lineVertexIndex++] = p.x;
                            lPos[lineVertexIndex++] = p.y;
                            lPos[lineVertexIndex++] = p.z;

                            lPos[lineVertexIndex++] = p2.x;
                            lPos[lineVertexIndex++] = p2.y;
                            lPos[lineVertexIndex++] = p2.z;
                        }
                    }
                }

                // Update Geometry
                pointSystem.geometry.attributes.position.needsUpdate = true;
                lineSystem.geometry.attributes.position.needsUpdate = true;

                // IMPORTANT: Tell renderer how many lines to draw
                lineSystem.geometry.setDrawRange(0, lineVertexIndex / 3);

                // Gentle Rotation
                scene.rotation.y += 0.001;
                scene.rotation.x += 0.0005;

                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            };

            animate();

            // Handle Resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        };

        initSpace();

        // --- 2. NAVIGATION & LAYOUT FIXES ---
        function navigateSlide(index) {
            const s1 = document.getElementById('welcomeState');
            const s2 = document.getElementById('dashboard');
            const i1 = document.getElementById('ind-airlock');
            const i2 = document.getElementById('ind-deck');

            if (index === 0) {
                s1.style.transform = 'translateX(0)';
                s2.style.transform = 'translateX(100%)';
                i1.className = 'text-cyan-400'; i2.className = 'text-slate-600 cursor-pointer';
            } else {
                s1.style.transform = 'translateX(-100%)';
                s2.style.transform = 'translateX(0)';
                i1.className = 'text-slate-600 cursor-pointer'; i2.className = 'text-cyan-400';

                // CRITICAL: Force Plotly Resize AFTER transition
                setTimeout(resizeCharts, 600);
            }
        }

        function resizeCharts() {
            console.log("Resizing charts for viewport...");
            const charts = ['heatmapChart', 'trendChart'];
            charts.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.data) { // Check if Plotly initialized
                    Plotly.Plots.resize(el);
                }
            });
        }

        window.addEventListener('resize', () => {
            // Debounce resize
            clearTimeout(window.resizeTimer);
            window.resizeTimer = setTimeout(resizeCharts, 200);
        });

        // --- 3. RENDERING FUNCTIONS ---

        // Heatmap
        function renderHeatmap(charts) {
            const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            const hours = Array.from({ length: 24 }, (_, i) => i);

            const data = [{
                z: charts.heatmap_z,
                x: hours,
                y: days,
                type: 'heatmap',
                colorscale: [
                    [0, '#0f172a'], [0.2, '#1e1b4b'], [0.4, '#4c1d95'],
                    [0.6, '#9f1239'], [0.8, '#ea580c'], [1, '#facc15']
                ],
                showscale: false // Hide sidebar to save space if needed
            }];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 10, l: 40, r: 10, b: 30 }, // Tight margins
                xaxis: {
                    tickfont: { color: '#94a3b8', size: 10 },
                    title: { text: 'Hour of Day', font: { size: 10, color: '#64748b' } }
                },
                yaxis: {
                    tickfont: { color: '#94a3b8', size: 10 },
                    autorange: 'reversed'
                }
            };

            Plotly.newPlot('heatmapChart', data, layout, { responsive: true, displayModeBar: false });
        }

        // Trend Line
        function renderTrend(charts) {
            const data = [{
                x: charts.dates,
                y: charts.scores,
                type: 'scatter',
                mode: 'lines',
                line: { color: '#22d3ee', width: 3, shape: 'spline' },
                fill: 'tozeroy',
                fillcolor: 'rgba(34, 211, 238, 0.1)'
            }];

            const layout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                margin: { t: 10, l: 40, r: 10, b: 30 },
                xaxis: { showgrid: false, tickfont: { color: '#94a3b8', size: 10 } },
                yaxis: {
                    gridcolor: '#1e293b',
                    tickfont: { color: '#94a3b8', size: 10 }
                }
            };

            Plotly.newPlot('trendChart', data, layout, { responsive: true, displayModeBar: false });
        }

        // Equalizer (CSS Based)
        function renderEqualizer(values) {
            const container = document.getElementById('equalizerChart');
            container.innerHTML = '';
            const max = Math.max(...values, 100);
            const days = ['M', 'T', 'W', 'T', 'F', 'S', 'S'];

            values.slice(0, 7).forEach((val, i) => {
                const h = (val / max) * 100;
                const div = document.createElement('div');
                div.className = "flex-1 flex flex-col items-center justify-end h-full group";
                div.innerHTML = `
                    <div class="relative w-full bg-cyan-900/30 rounded-t-sm transition-all duration-700 group-hover:bg-cyan-400/50" style="height: ${h}%">
                         <div class="absolute top-0 left-0 w-full h-[2px] bg-cyan-400 shadow-[0_0_10px_cyan]"></div>
                    </div>
                    <div class="mt-2 text-[10px] text-slate-500 font-mono">${days[i]}</div>
                `;
                container.appendChild(div);
            });
        }

        // Reactor
        function renderReactor(score) {
            const pct = Math.round(score * 100);
            let color = '#10b981';
            if (pct > 40) color = '#fbbf24';
            if (pct > 70) color = '#f43f5e';

            document.getElementById('reactorValue').innerText = pct + '%';
            document.getElementById('reactorValue').style.color = color;
            document.getElementById('reactorFill').style.background = `conic-gradient(${color} ${pct * 3.6}deg, transparent 0deg)`;
        }

        // Gemini Typer
        function renderGemini(text) {
            const div = document.getElementById('geminiContent');
            div.innerHTML = '';
            // Simple markdown parser
            const html = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-cyan-300 block mt-2 mb-1">$1</strong>').replace(/\n/g, '<br>');

            let i = 0;
            const type = () => {
                if (i < html.length) {
                    div.innerHTML = html.substring(0, i + 1) + '<span class="animate-pulse">_</span>';
                    i++;
                    setTimeout(type, 5); // Fast type
                } else {
                    div.innerHTML = html;
                }
            };
            type();
        }

        // Stats Footer
        function renderStats(stats) {
            const f = document.getElementById('statsFooter');
            f.innerHTML = `
                <div class="text-center"><div class="text-[10px] text-slate-500 uppercase">Total Events</div><div class="text-xl font-bold text-white">${stats.total_events}</div></div>
                <div class="text-center"><div class="text-[10px] text-slate-500 uppercase">Bad Days</div><div class="text-xl font-bold text-rose-400">${stats.bad_days}</div></div>
                <div class="text-center"><div class="text-[10px] text-slate-500 uppercase">Risk Ratio</div><div class="text-xl font-bold text-amber-400">${(stats.bad_ratio * 100).toFixed(1)}%</div></div>
                <div class="text-center"><div class="text-[10px] text-slate-500 uppercase">Date Range</div><div class="text-[10px] text-slate-300 mt-1">${stats.date_range.start}<br>${stats.date_range.end}</div></div>
            `;
        }

        // --- 4. DATA HANDLING ---
        async function loadSampleData() {
            startLoading();
            await new Promise(r => setTimeout(r, 1500)); // Fake processing

            const sample = {
                forecast: { risk_score: 0.72 },
                charts: {
                    radar_values: [50, 80, 40, 90, 20, 60, 100],
                    heatmap_z: Array(7).fill().map(() => Array(24).fill().map(() => Math.floor(Math.random() * 50))),
                    dates: ['2023-01', '2023-02', '2023-03', '2023-04'],
                    scores: [150, 200, 350, 280]
                },
                gemini: "**Pattern Detected**\nHigh volatility in late-night usage.\n\n**Action**\nEnforce rigid sleep schedule protocols.",
                statistics: { total_events: 8432, bad_days: 12, bad_ratio: 0.45, date_range: { start: '2024-01', end: '2024-02' } }
            };

            finishLoading(sample);
        }

        async function handleFile() {
            const input = document.getElementById('fileInput');
            if (!input.files[0]) return;

            startLoading();
            const formData = new FormData();
            formData.append('file', input.files[0]);

            try {
                const res = await fetch('http://localhost:8000/analyze', { method: 'POST', body: formData });
                if (!res.ok) throw new Error("Server Error");
                const data = await res.json();
                finishLoading(data);
            } catch (e) {
                alert("Analysis Failed: " + e.message);
                stopLoading();
            }
        }

        function startLoading() {
            window.isWarping = true;
            document.getElementById('loading').classList.remove('hidden');
            let step = 1;
            window.loadInterval = setInterval(() => {
                if (step <= 4) {
                    document.getElementById(`step-${step}`).classList.add('active');
                    if (step > 1) document.getElementById(`step-${step - 1}`).classList.remove('active');
                    if (step > 1) document.getElementById(`step-${step - 1}`).classList.add('done');
                    step++;
                }
            }, 400);
        }

        function finishLoading(data) {
            clearInterval(window.loadInterval);
            renderReactor(data.forecast.risk_score);
            renderEqualizer(data.charts.radar_values);
            renderHeatmap(data.charts);
            renderTrend(data.charts);
            renderGemini(data.gemini);
            renderStats(data.statistics);

            setTimeout(() => {
                window.isWarping = false;
                document.getElementById('loading').classList.add('hidden');
                navigateSlide(1);
            }, 500);
        }

        function stopLoading() {
            window.isWarping = false;
            document.getElementById('loading').classList.add('hidden');
            clearInterval(window.loadInterval);
        }

        // 3D Core for Airlock
        const initCore = () => {
            const container = document.getElementById('neural-core-container');
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(75, 1, 0.1, 100);
            camera.position.z = 2.5;
            const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
            renderer.setSize(160, 160);
            container.appendChild(renderer.domElement);

            const geo = new THREE.IcosahedronGeometry(1.2, 0);
            const mat = new THREE.MeshBasicMaterial({ color: 0x06b6d4, wireframe: true });
            const mesh = new THREE.Mesh(geo, mat);
            scene.add(mesh);

            const animate = () => {
                mesh.rotation.x += 0.01;
                mesh.rotation.y += 0.01;
                renderer.render(scene, camera);
                requestAnimationFrame(animate);
            };
            animate();
        };
        initCore();

        function resetSystem() {
            navigateSlide(0);
            document.getElementById('fileInput').value = '';
        }
    </script>
</body>

</html>